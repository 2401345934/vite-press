# 小程序面试题

## 小程序是双线程架构还是单线程架构？

1. 小程序的架构模型有别与传统web单线程架构，小程序为双线程架构。
2. 微信小程序的渲染层与逻辑层分别由两个线程管理，渲染层的界面使用 webview 进行渲染；逻辑层采用 JSCore运行JavaScript代码
  a. 由于渲染层与逻辑层分开，一个小程序有多个界面，所以渲染层对应存在多个webview。
  b. 这两个线程之间由Native层进44行统一处理。无论是线程之间的通讯、数据的传递、网络请求都由Native层做转发。
3. 这里的webview是什么呢
  a.  可以想象webview是一个嵌入式的浏览器，是嵌入在原生应用中的
  b. webview 用来展示网页的 view 组件，使用 webkit 渲染引擎来展示，并且支持前进后退、浏览历史、放大缩小、等更多功能。
4. 并且小程序 会有 多个 webview
  a. 为了更加接近原生应用APP的用户体验。多个webview可以理解为多页面应用，有别于单页面应用SPA，SPA渲染页面是通过路由识别随后动态将页面挂载到root节点中去
  b. 如果单页面应用打开一个新的页面，需要先卸载掉当前页面结构，并且重新渲染。很显然原生APP并不是这个样子，比较明显的特征为从页面右侧向左划入一个新的页面，并且我们可以同时看到两个页面。
5. Native 主要做了什么
  a.  Native层除了做一些资源的动态注入，还负责着很多的事情，请求的转发，离线存储，组件渲染等等。
  b. 界面主要由成熟的 Web 技术渲染，辅之以大量的接口提供丰富的客户端原生能力。

## 小程序中 为什么不能在 onLaunch 里面阻止页面显示 达到有必须要最先请求的 接口响应 在展示 小程序页面

1. 因为小程序是双线程架构  
2. 一个线程解析 运行 js
3. 一个线程用来渲染 webview
4. 所以不像 web 端等 单线程 架构 js代码无法阻塞 webview 的展示
解决方案
1. 通过自定义 tab-bar  nav-bar 还有一个每个页面都在使用的 公共组件可以实现
2. 统一通过 变量所有组件默认隐藏
3. 等到接口回来再去修改这个统一变量
4. * 注意边界 和容错处理 不要因为接口报错导致页面一直空白

## 小程序 view text 到底是什么 ？ 又是如何实现的 ？

1. 小程序 的 view text 标签是通过  渲染层中编译后的 Exparser 自定义组件标记  
2. 会通过 $gwx() 函数 结合一些文件路径 动态数据生成 virtualDOM 虚拟dom
3. text 生成 virtualDOM   的 tag 就是 wx-text
4. view 生成 virtualDOM   的 tag 就是 wx-view

## 小程序中 为什么不能直接操作 dom 节点？

1. 为了解决安全管控问题，小程序阻止开发者使用一些浏览器提供的比如跳转页面、操作DOM、动态执行脚本的开放性接口。
2. 如果这些东西一个一个地去禁用，那么势必会进入一个糟糕的循环，因为javascript实在是太灵活了，浏览器的接口也太丰富了，很容易就遗漏一些危险的接口，而且就算是禁用掉了所有感觉到危险的接口，也势必防不住浏览器内核的下次更新。指不定又会出现一些漏洞。
3. 要彻底解决这个问题，必须提供一个沙箱环境来运行开发者的JavaScript 代码。这个沙箱环境不能有任何浏览器相关接口，只提供纯JavaScript 的解释执行环境
4. 那么像HTML5中的ServiceWorker、WebWorker特性就符合这样的条件，这两者都是启用另一线程来执行 javaScript。
5. 考虑到小程序是一个多 webView 的架构，每一个小程序页面都是不同的webView 渲染后显示的，在这个架构下不好去用某个webView中的ServiceWorker去管理所有的小程序页面。
6. 得益于客户端系统有javaScript 的解释引擎（在iOS下使用内置的 javaScriptCore框架，在安卓则是用腾讯x5内核提供的JsCore环境），可以创建一个单独的线程去执行 javaScript，在这个环境下执行的都是有关小程序业务逻辑的代码
