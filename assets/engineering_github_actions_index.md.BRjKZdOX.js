import{_ as t,o as p,c as o,J as s,w as c,m as n,a as l,aa as r,E as a}from"./chunks/framework.DJCjJe2w.js";const _=JSON.parse('{"title":"Actions","description":"","frontmatter":{"createTime":"2022/11/10","tag":"工程化,GitHub"},"headers":[],"relativePath":"engineering/github/actions/index.md","filePath":"engineering/github/actions/index.md","lastUpdated":1668091633000}'),u={name:"engineering/github/actions/index.md"},d=n("h1",{id:"actions",tabindex:"-1"},[l("Actions "),n("a",{class:"header-anchor",href:"#actions","aria-label":'Permalink to "Actions"'},"​")],-1),b=r(`<h2 id="github-actions" tabindex="-1">GitHub Actions <a class="header-anchor" href="#github-actions" aria-label="Permalink to &quot;GitHub Actions&quot;">​</a></h2><p>GitHub Actions 是一个持续集成 (Continuous integration)和持续交付 (Continuous delivery)的平台，它可以做到自动化构建、测试、部署。你可以创建工作流，构建和测试每一个 pull request 或者部署合并后的代码到生产环境。</p><p>GitHub Actions 可以在你的代码仓库发生某个事件时运行一个工作流。举个例子，当有人给你的代码仓库新建了一个 issue，你可以跑一个工作流自动的添加合适的标签。</p><p>GitHub 提供了 Linux、Windows、和 macOS 虚拟机运行你的工作流，当然你也可以自定义运行环境。</p><h2 id="github-actions-组件" tabindex="-1">GitHub Actions 组件 <a class="header-anchor" href="#github-actions-组件" aria-label="Permalink to &quot;GitHub Actions 组件&quot;">​</a></h2><p>你可以配置一个 GitHub Actions <strong>工作流（workflow</strong>），它会在你的仓库发生某个事件时被触发，就比如一个 pull request 或者一个 issue 被创建的时候。</p><p>你的工作流包含一个或者多个<strong>任务（jobs）</strong>， 它们可以并行或者串行执行。每一个任务（jobs）都会在它自己的虚拟机<strong>运行器(runner)<strong>上，任务可以有一个或者多个</strong>步骤（steps）</strong>，可以运行一个自定义的脚本或者运行一个<strong>动作（action）</strong>，所谓动作（action）是一个可复用的扩展，用于简化你的工作流。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e571673188b4746964e20a6314f83f7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt=""></p><h3 id="workflows-工作流" tabindex="-1">Workflows（工作流） <a class="header-anchor" href="#workflows-工作流" aria-label="Permalink to &quot;Workflows（工作流）&quot;">​</a></h3><p>工作流是一个可配置的自动化的程序。创建一个工作流，你需要定义一个 YAML 文件，当你的仓库触发某个事件的时候，工作流就会运行，当然也可以手动触发，或者定义一个时间表。</p><p>一个仓库可以创建多个工作流，每一个都执行不同的步骤，举个例子，一个工作流用于构建和测试 pull request，一个用于部署你的应用，再来一个，当有人新建 issue 的时候自动添加一个标签。</p><p>你也可以在一个工作流中引用另外一个工作流，查看「<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.github.com%2Fen%2Factions%2Flearn-github-actions%2Freusing-workflows" title="https://docs.github.com/en/actions/learn-github-actions/reusing-workflows" target="_blank" rel="noreferrer">可复用工作流</a>」。</p><h3 id="事件-events" tabindex="-1">事件（Events） <a class="header-anchor" href="#事件-events" aria-label="Permalink to &quot;事件（Events）&quot;">​</a></h3><p>事件是指仓库触发运行工作流的具体的行为，比如创建一个 pull request，新建一个 issue、或者推送一个 commit。你也可以使用时间表触发一个工作流，或者通过请求一个 REST API，再或者手动触发。</p><p>事件完整的列表，可以查看「<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.github.com%2Fen%2Factions%2Freference%2Fevents-that-trigger-workflows" title="https://docs.github.com/en/actions/reference/events-that-trigger-workflows" target="_blank" rel="noreferrer">触发工作流的事件</a>」。</p><h3 id="任务-jobs" tabindex="-1">任务（Jobs） <a class="header-anchor" href="#任务-jobs" aria-label="Permalink to &quot;任务（Jobs）&quot;">​</a></h3><p>任务是在同一个运行器上执行的一组步骤（steps）。一个步骤（steps）要么是一个shell 脚本（script）要么是一个动作（action）。步骤会顺序执行，并彼此独立。因为每一个步骤都在同一个运行器上被执行，所以你可以从一个步骤（step）传递数据到另一个步骤（step） 。</p><p>你可以配置一个任务依赖其他任务，默认情况下，任务没有依赖，并行执行。当一个任务需要另外一个任务的时候，它会等到依赖的任务完成再执行。</p><h3 id="动作-actions" tabindex="-1">动作（Actions） <a class="header-anchor" href="#动作-actions" aria-label="Permalink to &quot;动作（Actions）&quot;">​</a></h3><p>动作是 GitHub Actions 平台的一个自定义的应用，它会执行一个复杂但是需要频繁重复的作业。使用动作可以减少重复代码。比如一个 action 可以实现从 GitHub 拉取你的 git 仓库，为你的构建环境创建合适的工具链等。</p><p>你可以写自己的动作 ，或者在 GitHub 市场找已经实现好的动作。</p><h3 id="运行器-runners" tabindex="-1">运行器（Runners） <a class="header-anchor" href="#运行器-runners" aria-label="Permalink to &quot;运行器（Runners）&quot;">​</a></h3><p>一个运行器是一个可以运行工作流的服务。每一个运行器一次只运行一个单独的任务。GitHub 提供 Ubuntu Linux，Microsoft Windows 和 macOS 运行器，每一个工作流都运行在一个独立新建的虚拟机中。如果你需要一个不同的操作系统，你可以自定义运行器。请查看「<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.github.com%2Fen%2Factions%2Fhosting-your-own-runners" title="https://docs.github.com/en/actions/hosting-your-own-runners" target="_blank" rel="noreferrer">自定义运行器</a>」。</p><h2 id="创建一个工作流" tabindex="-1">创建一个工作流 <a class="header-anchor" href="#创建一个工作流" aria-label="Permalink to &quot;创建一个工作流&quot;">​</a></h2><p>GitHub Actions 使用 YAML 语法定义工作流。每一个工作流保存为一个独立的 YAML 文件，目录是 <code>.github/workflows</code> 。</p><p>现在我们在代码仓库创建一个示例工作流，当代码被推送的时候，会自动执行一系列的命令。在这个示例工作流中，GitHub Actions 会检出提交的代码，安装依赖，运行 <code>bats -v</code>：</p><ol><li>在你的仓库，创建一个 <code>.github/workflows/</code> 目录</li><li>在 <code>.github/workflows/</code> 目录，创建一个文件，名为 <code>learn-github-actions.yml</code> ，添加下面的代码：</li></ol><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>name: learn-github-actions</span></span>
<span class="line"><span>on: [push]</span></span>
<span class="line"><span>jobs:</span></span>
<span class="line"><span>  check-bats-version:</span></span>
<span class="line"><span>    runs-on: ubuntu-latest</span></span>
<span class="line"><span>    steps:</span></span>
<span class="line"><span>      - uses: actions/checkout@v2</span></span>
<span class="line"><span>      - uses: actions/setup-node@v2</span></span>
<span class="line"><span>        with:</span></span>
<span class="line"><span>          node-version: &#39;14&#39;</span></span>
<span class="line"><span>      - run: npm install -g bats</span></span>
<span class="line"><span>      - run: bats -v</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="3"><li>提交这些改动，推送到你的 GitHub 仓库。</li></ol><p>你的新 GitHub Actions 工作流文件就会被安装在你的仓库，当有人提交代码的时候，工作流就会自动执行。关于一个任务的执行历史，查看「<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.github.com%2Fcn%2Factions%2Flearn-github-actions%2Fintroduction-to-github-actions%23viewing-the-jobs-activity" title="https://docs.github.com/cn/actions/learn-github-actions/introduction-to-github-actions#viewing-the-jobs-activity" target="_blank" rel="noreferrer">查看工作流活动</a>」章节。</p><h2 id="理解工作流文件" tabindex="-1">理解工作流文件 <a class="header-anchor" href="#理解工作流文件" aria-label="Permalink to &quot;理解工作流文件&quot;">​</a></h2><p>为了帮助你理解 YAML 语法，这节会解释例子中的每行代码：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>name: learn-github-actions</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>可选，工作流的名字，会出现在 GitHub 仓库的 Actions 选项栏里。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>on: [push]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>指定工作流的触发事件。这个例子里，使用是 <code>push</code> 事件，当有人提交了一个代码修改或者合并了一个 pull request ，工作流就会触发。提交到每个分支都会被触发，如果你想在指定分支、路径、标签，查看 「<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.github.com%2Factions%2Freference%2Fworkflow-syntax-for-github-actions%23onpushpull_requestpaths" title="https://docs.github.com/actions/reference/workflow-syntax-for-github-actions#onpushpull_requestpaths" target="_blank" rel="noreferrer">GitHub Actions 工作流语法</a>」</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>jobs:</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>将运行在 <code>learn-github-actions</code> 工作流的所有任务分组在一起。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>check-bats-version:</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>定义了一个名为<code>check-bats-version</code> 的任务，子键（child key）会定义该任务的属性。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>  runs-on: ubuntu-latest</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>配置任务运行在最新的 Ubuntu Linux 运行器。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span> steps:</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>将 <code>check-bats-version</code> 任务下的所有步骤分为一组，嵌套的每一个条目都是一个独立的 action 或者 shell 脚本。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>- uses: actions/checkout@v2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><code>uses</code> 关键字指定了这个步骤运行 <code>actions/checkout</code> 动作的 <code>v2</code> 大版本 。这是一个可以检出仓库代码到运行器的动作，它允许你运行脚本或者其他动作侵入你的代码（比如构建或者测试工具）。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>- uses: actions/setup-node@v2</span></span>
<span class="line"><span>  with:</span></span>
<span class="line"><span>    node-version: &#39;14&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个步骤会使用 <code>actions/setup-node@v2</code> 动作安装指定版本的 Nodejs ，这会在你的 <code>PATH</code> 加上 <code>node</code> 和 <code>npm</code> 命令。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>- run: npm install -g bats</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><code>run</code> 关键字会告诉任务在运行器上执行一个命令。在这个例子中，你正在使用 <code>npm</code> 安装 <code>bats</code> 软件测试包。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>- run: bats -v</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>最终，你运行 <code>bats</code> 命令，传入一个可以打印软件版本的参数。</p><h2 id="可视化工作流文件" tabindex="-1">可视化工作流文件 <a class="header-anchor" href="#可视化工作流文件" aria-label="Permalink to &quot;可视化工作流文件&quot;">​</a></h2><p>在这个图表，你可以看到你刚创建的工作流文件，以及这些 GitHub Actions 组件是如何组织的。每一个步骤都会执行一个独立的动作或者脚本文件。任务1 和 2 是运行命令，任务3 和 任务 4 是运行脚本文件。找到更多预构建的动作，查看 「<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.github.com%2Fcn%2Factions%2Flearn-github-actions%2Ffinding-and-customizing-actions" title="https://docs.github.com/cn/actions/learn-github-actions/finding-and-customizing-actions" target="_blank" rel="noreferrer">查找和自定义动作</a>」。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/793521037ba24f5c82c9ae141071ad33~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt=""></p><h2 id="查看工作流活动" tabindex="-1">查看工作流活动 <a class="header-anchor" href="#查看工作流活动" aria-label="Permalink to &quot;查看工作流活动&quot;">​</a></h2><p>一旦你的工作流开始运行，你可以在 GitHub 看到一个可视化的运行进度图表 ，查看每一个步骤的执行情况。</p><ol><li>在 GitHub.com ，导航至仓库主页</li><li>在你的仓库名下，点击 <code>Actions</code>。</li></ol><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ea97a5bc77241e58832aec26e1d7054~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt=""></p><ol start="3"><li>在左侧 sidebar，点击你想查看的工作流</li></ol><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/21c2e97bfaef4bfe8b35cdbe11ffd5c6~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt=""></p><ol start="4"><li>在 <code>Workflow runs</code> ，点击你想查看的运行记录的名称：</li></ol><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/15235d4e7ff84ca2910f7c598c325e70~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt=""></p><ol start="5"><li>在 Jobs 或者在可视化图表中，点击你想看到的任务：</li></ol><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/876bdfd61f184baba73206b4363b1cd4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt=""></p><ol start="6"><li>查看每一个步骤的结果：</li></ol><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f55f15a850a14c9e948c2efb48de30f7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt=""></p><h2 id="上篇文章代码解析" tabindex="-1">上篇文章代码解析 <a class="header-anchor" href="#上篇文章代码解析" aria-label="Permalink to &quot;上篇文章代码解析&quot;">​</a></h2><p>现在我们再来看 GitHub 同步 Gitee 的代码，是不是就清楚很多了：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>name: syncToGitee</span></span>
<span class="line"><span>on:</span></span>
<span class="line"><span>  push:</span></span>
<span class="line"><span>    branches:</span></span>
<span class="line"><span>      - gh-pages</span></span>
<span class="line"><span>jobs:</span></span>
<span class="line"><span>  repo-sync:</span></span>
<span class="line"><span>    runs-on: ubuntu-latest</span></span>
<span class="line"><span>    steps:</span></span>
<span class="line"><span>      - name: Mirror the Github organization repos to Gitee.</span></span>
<span class="line"><span>        uses: Yikun/hub-mirror-action@master</span></span>
<span class="line"><span>        with:</span></span>
<span class="line"><span>          src: &#39;github/mqyqingfeng&#39;</span></span>
<span class="line"><span>          dst: &#39;gitee/mqyqingfeng&#39;</span></span>
<span class="line"><span>          dst_key: \${{ secrets.GITEE_PRIVATE_KEY }}</span></span>
<span class="line"><span>          dst_token:  \${{ secrets.GITEE_TOKEN }}</span></span>
<span class="line"><span>          static_list: &quot;learn-typescript&quot;</span></span>
<span class="line"><span>          force_update: true</span></span>
<span class="line"><span>          debug: true</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>在这个例子里，我们定义了一个名为 <code>syncToGitee</code> 的工作流，指定代码提交到分支 <code>gh-pages</code> 才触发工作流。</p><p>任务下只有一个名为 <code>repo-sync</code> 的任务，运行在 <code>ubuntu-latest</code>，具体的步骤下，也只有一个名为 <code>Mirror the GitHub organization repos to Gitee.</code> 的步骤，使用了 <code>Yikun/hub-mirror-action@master</code> 动作，而 <code>with</code> 里的内容则是该动作需要的一些参数。</p>`,72);function h(m,g,v,k,f,w){const e=a("ArticleMetadata"),i=a("ClientOnly");return p(),o("div",null,[d,s(i,null,{default:c(()=>[s(e)]),_:1}),b])}const A=t(u,[["render",h]]);export{_ as __pageData,A as default};
